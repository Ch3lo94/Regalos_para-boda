<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Regalos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; }
  #bienvenido, #catalogo { max-width: 600px; margin: auto; }
  .item {
    background: white; padding: 15px; border-radius: 10px;
    margin-bottom: 15px; box-shadow: 0 0 5px rgba(0,0,0,0.2);
  }
  .item img { width: 100%; border-radius: 10px; }
  .item button {
    margin-top: 10px; padding: 10px; width: 100%;
    border: none; background:#007bff; color:white;
    border-radius: 8px; font-size:16px; cursor:pointer;
  }
  .selected button { background: green !important; }
  #confirmar-btn {
    margin-top: 20px; display:none; background:#28a745 !important;
  }
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>

<!-- LOGIN -->
<div id="bienvenido">
  <h2 style="text-align:center;">Iniciar sesión</h2>
  <div id="googleLogin"></div>
</div>

<!-- CATÁLOGO -->
<div id="catalogo" style="display:none;">
  <h2 style="text-align:center;">Catálogo de Regalos</h2>
  <div id="lista"></div>
  <button id="confirmar-btn">Confirmar selección</button>
</div>

<script>
let seleccion = null;
let userEmail = null;

window.onload = () => {
  google.accounts.id.initialize({
    client_id: "AKfycbwY5TFcoek-m0zWHTNGDp8LF_1uGKZvS6Ear6kPErZFz8R2Fl9MuDKx885b_RFufvWI",
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(
    document.getElementById("googleLogin"),
    { theme: "outline", size: "large" }
  );
};

function handleCredentialResponse(response) {
  const data = JSON.parse(atob(response.credential.split('.')[1]));
  userEmail = data.email;

  document.getElementById("bienvenido").style.display = "none";
  document.getElementById("catalogo").style.display = "block";
  cargarCatalogo();
}

function cargarCatalogo() {
  const URL_STOCK =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQjpCXd4OsYOfhRamCDGBGAudi3ugOIqKzgaeVaqz0Dre2GV3a_s26KxDmEVRB0B8j6gDFniJCJoAav/gviz/tq?gid=149275084&tqx=out:json";

  fetch(URL_STOCK)
    .then(r => r.text())
    .then(txt => {
      const json = JSON.parse(txt.substring(47, txt.length - 2));
      const rows = json.table.rows;

      const regalos = rows.map(r => ({
        nombre: r.c[1]?.v || "",
        max: r.c[2]?.v || 0,
        stockRestante: r.c[3]?.v || 0,
        imagen: r.c[4]?.v || ""
      }));

      mostrarCatalogo(regalos);
    });
}

function mostrarCatalogo(regalos) {
  const cont = document.getElementById("lista");
  cont.innerHTML = "";

  regalos.forEach((reg, index) => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="${reg.imagen}">
      <h3>${reg.nombre}</h3>
      <p>Existencias: ${reg.stockRestante}</p>
      <button onclick="seleccionar(${index}, this)">Seleccionar</button>
    `;
    cont.appendChild(div);
  });
}

function seleccionar(id, btn) {
  document.querySelectorAll(".item button").forEach(b => {
    b.parentElement.classList.remove("selected");
  });

  btn.parentElement.classList.add("selected");
  seleccion = id;

  document.getElementById("confirmar-btn").style.display = "block";
}

document.getElementById("confirmar-btn").onclick = () => {
  if (seleccion === null) return alert("Seleccioná un regalo.");

  alert("¡Gracias por tu regalo! ❤️");
  document.getElementById("confirmar-btn").style.display = "none";
  cargarCatalogo();
};
</script>

</body>
</html>
